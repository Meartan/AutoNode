<link rel="import" href="message-list.html">

<polymer-element name="message-control" attributes="websocketServer show">
  <template>
    <style type="text/css">
    core-header-panel{
    	float: left;
    	width: 100%;
    	height: 700px;
    	margin: 0px;
    }
    core-toolbar{
    	height: 60px;
    	line-height: 60px;
    	font-size: 18px;
    	padding: 0 10px;
    	background-color: #4F7DC9;
    	color: #FFF;
    	transition: height 0.2s;
    }
    paper-dialog{
      width: 500px;
    }
    paper-input{
      width: 100%;
    }
    paper-toast.ok{
      background-color: green;
    }
    paper-toast.error{
      background-color: red;
    }
    paper-toast.pending{
      background-color: #CCCC00;
    }
    </style>
    <paper-toast id="toast" class="capsule" duration="6000" style="padding-right: 60px;"></paper-toast>
    <paper-dialog heading="New Message" id="messageDialog" transition="paper-dialog-transition-bottom">
      <paper-input id="inputNewMessage" label="Message" floatingLabel></paper-input>
      <paper-input id="selectedDevice" label="To device" floatingLabel></paper-input>
      <paper-button label="Send" affirmative on-tap="{{sendMessage}}"></paper-button>
      <paper-button label="Cancel" dismissive></paper-button>
    </paper-dialog>
  	<core-header-panel mode="waterfall">
    		<core-toolbar>
          <span flex>Message History</span>
          <paper-icon-button icon="add-box" on-click="{{showNewMessageDialog}}"></paper-icon-button>
        </core-toolbar>
      		<div>
            <message-list id="messageList" on-status-update="{{statusUpdated}}">
            </message-list>
      		</div>
    </core-header-panel>
  </template>
  <script>
  Polymer('message-control', {
    publish: {
    },
    sendMessage: function(){
      var id= this.$.inputNewDevice.value;
      console.log("Inserting: " + id);
      this.$.insertRequest.body = JSON.stringify({"id":id});
      this.$.insertRequest.go();
      this.showToast("Inserting device...");
    },
    showNewMessageDialog: function(){
      this.$.messageDialog.toggle();
    },
    handleMessageReceived: function(event, details){
      var result = details.response.result;
      var toastText = null;
      if(result.status == "ok"){
        toastText = "Device Inserted.";
        this.$.messageList.refreshList();
      }else if(result.status == "pending"){
        this.$.messageList.refreshList();
      }{
        toastText = result.text;
      }
      this.showToast(toastText,result.status);

    },
    showToast: function(text, status){
      this.$.toast.text = text;
      for (var i = 0; i < this.statuses.length; i++) {
        var statusToRemove = this.statuses[i];
        this.$.toast.classList.remove(statusToRemove);
      };
      if(status != null){
        this.$.toast.classList.add(status);
      }
      this.$.toast.show();
    },
    statuses: ["ok","error","pending"],
    statusUpdated : function(event,detail){
      this.showToast(detail.text,detail.status);
    },
    created: function() {

    },
    websocketServerChanged: function(oldValue, newValue) {
      var me = this;
      var socket = null;
      console.log(newValue);
      function connect() {

        if (socket !== null)
          return;
        var url = me.websocketServer;
        console.log("websocketServer: " + url);
        socket = new WebSocket(url);

        socket.onopen = function() {
          console.log('connected to ' + url);
        };

        socket.onmessage = function(e) {
          me.$.messageList.refreshList();
        };

        socket.onclose = function() {
          console.log('close');
        };
      }
      connect();
    }
});
  </script>

</polymer-element>
